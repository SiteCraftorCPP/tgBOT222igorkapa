# ๐ ะะพัะฝะตะฒะฐั ะฟัะธัะธะฝะฐ ะดัะฑะปะธัะพะฒะฐะฝะธั ัะธะณะฝะฐะปะพะฒ

## ะัะพะฑะปะตะผะฐ: Race Condition ะผะตะถะดั ัะธะบะปะฐะผะธ

### ะกัะตะฝะฐัะธะน ะดัะฑะปะธัะพะฒะฐะฝะธั:

```
ะฆะะะ 1 (3:11:00):
โโ refresh_prices() โ ัะตะฝะฐ JST = 0.0364โฌ, ะฟะฐะดะตะฝะธะต = -12.9%
โโ check_pair(JST)
โ  โโ check_levels(JST, price=0.0364, max=0.0418, triggered=[])
โ  โ  โโ drop_percent = -12.9% <= -12% (Level 2) โ
โ  โ  โโ triggered_levels = [] (ะฟัััะพ) โ
โ  โโ โ ะกะะะะะ ะกะะะะะ Level 2
โโ cycle_signals = [{pair: "JST", level: 2}]
โโ send_signals_batch() โ ะพัะฟัะฐะฒะปะตะฝะพ ะฒ Telegram โ
โโ add_triggered_level(JST, 2) โ triggered_levels = [2]
โโ save_states() โ ะทะฐะฟะธัะฐะฝะพ ะฒ pairs_state.json

ะฆะะะ 2 (3:12:00) - ะะะะะะะะ:
โโ refresh_prices() โ ัะตะฝะฐ JST = 0.0364โฌ (ะขะ ะะ ะฆะะะ), ะฟะฐะดะตะฝะธะต = -12.9%
โโ check_pair(JST)
โ  โโ get_state(JST) โ ะะะะะะะะ: ะผะพะถะตั ะฒะตัะฝััั ะกะขะะะะ ัะพััะพัะฝะธะต ะธะท ะฟะฐะผััะธ
โ  โโ check_levels(JST, price=0.0364, max=0.0418, triggered=[2])
โ  โ  โโ drop_percent = -12.9% <= -12% (Level 2) โ
โ  โ  โโ triggered_levels = [2] (ะตััั Level 2) โ
โ  โ  โโ continue (ะดะพะปะถะตะฝ ะฟัะพะฟัััะธัั)
โ  โโ โ ะะ ะะกะะ triggered_levels ะฝะต ะพะฑะฝะพะฒะธะปัั โ ะกะะะะะ ะกะะะะะ ัะฝะพะฒะฐ!
โโ ะะฃะะะฌ ะพัะฟัะฐะฒะปะตะฝ โ
```

---

## ๐ด ะัะฝะพะฒะฝัะต ะฟัะธัะธะฝั ะดัะฑะปะธัะพะฒะฐะฝะธั:

### 1. **ะัะพะฑะปะตะผะฐ ั ัะพััะฐะฝะตะฝะธะตะผ ัะพััะพัะฝะธั ะผะตะถะดั ัะธะบะปะฐะผะธ**

```python
# state_manager.py:68-73
def update_state(self, pair: str, **kwargs):
    state = self.get_state(pair)
    state.update(kwargs)
    state["last_update"] = time.time()
    self.save_states()  # โ ะกะพััะฐะฝัะตั ะะกะ ัะพััะพัะฝะธะต ะฒัะตั ะฟะฐั!
```

**ะัะพะฑะปะตะผะฐ**: `save_states()` ัะพััะฐะฝัะตั **ะะกะ** ัะพััะพัะฝะธะต ะฒัะตั ะฟะฐั ะฒ ัะฐะนะป. ะญัะพ ะพะทะฝะฐัะฐะตั:
- ะัะปะธ ะผะตะถะดั ัะธะบะปะฐะผะธ ะฟัะพะธััะพะดะธั `update_state()` ะดะปั ะดััะณะพะน ะฟะฐัั, ัะฐะนะป ะฟะตัะตะทะฐะฟะธััะฒะฐะตััั
- ะัะปะธ ัะพััะพัะฝะธะต ะฒ ะฟะฐะผััะธ (`self.states`) ะฝะต ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝะพ ั ัะฐะนะปะพะผ, ะผะพะถะตั ะฑััั ัะฐััะธะฝััะพะฝะธะทะฐัะธั

### 2. **ะัะพะฑะปะตะผะฐ ั ะทะฐะณััะทะบะพะน ัะพััะพัะฝะธั ะฒ ะฝะฐัะฐะปะต ัะธะบะปะฐ**

```python
# bot.py:101-114
for pair in pairs:
    result = self.check_pair(pair, current_time, stats)
    # ...
```

**ะัะพะฑะปะตะผะฐ**: `check_pair()` ะฒัะทัะฒะฐะตั `get_state()`, ะบะพัะพััะน ัะธัะฐะตั ะธะท `self.states` ะฒ ะฟะฐะผััะธ. ะะพ:
- ะัะปะธ ะผะตะถะดั ัะธะบะปะฐะผะธ `save_states()` ะฝะต ััะฟะตะป ะทะฐะฟะธัะฐัั ะฒ ัะฐะนะป
- ะะปะธ ะตัะปะธ ัะพััะพัะฝะธะต ะฝะต ะฟะตัะตะทะฐะณััะถะตะฝะพ ะธะท ัะฐะนะปะฐ
- ะขะพ `triggered_levels` ะผะพะถะตั ะฑััั ัััะฐัะตะฒัะธะผ

### 3. **ะัะพะฑะปะตะผะฐ ั ะฟัะพะฒะตัะบะพะน ััะพะฒะฝะตะน - ะฟัะพะฒะตััะตั ะะะะฆะะะข, ะฐ ะฝะต ัะฐะบั ะพัะฟัะฐะฒะบะธ**

```python
# market_monitor.py:243-244
if drop_percent <= threshold:
    return signal  # โ ะะพะทะฒัะฐัะฐะตั ัะธะณะฝะฐะป ะะกะฏะะะ ะะะ, ะบะพะณะดะฐ ะฟะฐะดะตะฝะธะต <= ััะพะฒะฝั
```

**ะัะพะฑะปะตะผะฐ**: `check_levels()` ะฟัะพะฒะตััะตั ัะพะปัะบะพ **ะฟัะพัะตะฝั ะฟะฐะดะตะฝะธั**, ะฐ ะฝะต ัะพ, ะฑัะป ะปะธ ัะธะณะฝะฐะป ัะถะต ะพัะฟัะฐะฒะปะตะฝ. ะัะปะธ ัะตะฝะฐ ะพััะฐัััั ะฝะฐ ัะพะผ ะถะต ััะพะฒะฝะต (-12.9%), ัะพ:
- ะะฐะถะดัะน ัะธะบะป ะฟัะพะฒะตัะบะฐ `drop_percent <= -12%` ะฒะตัะฝัั `True`
- ะัะปะธ `triggered_levels` ะฝะต ัะพะดะตัะถะธั Level 2, ัะพะทะดะฐัััั ัะธะณะฝะฐะป

### 4. **ะัะพะฑะปะตะผะฐ ั ะฒะพะปะฐัะธะปัะฝะพัััั ัะตะฝั ะฝะฐ ะณัะฐะฝะธัะต ััะพะฒะฝั**

```
ะฆะตะฝะฐ ะผะพะถะตั ะบะพะปะตะฑะฐัััั:
- ะฆะธะบะป 1: -12.8% โ ะฝะต ััะธะณะณะตัะธั Level 2 (-12%)
- ะฆะธะบะป 2: -12.9% โ ััะธะณะณะตัะธั Level 2 โ
- ะฆะธะบะป 3: -12.9% โ ะกะะะะ ััะธะณะณะตัะธั Level 2 โ (ะตัะปะธ ะฝะต ัะพััะฐะฝะตะฝะพ)
```

---

## ๐ก๏ธ ะะพัะตะผั ัะตะบััะฐั ะทะฐัะธัะฐ ะะ ะะะะะะกะขะฌะฎ ัะฐะฑะพัะฐะตั:

### ะัะพะฑะปะตะผะฐ 1: ะกะพััะพัะฝะธะต ะฒ ะฟะฐะผััะธ vs ัะฐะนะป

```python
# state_manager.py
self.states = {}  # โ ะกะพััะพัะฝะธะต ะฒ ะฟะฐะผััะธ
```

ะัะปะธ ะผะตะถะดั ะฒัะทะพะฒะฐะผะธ `save_states()` ะธ ัะปะตะดัััะตะน ะฟัะพะฒะตัะบะพะน ะฟัะพะธััะพะดะธั ัะฑะพะน ะธะปะธ ะทะฐะดะตัะถะบะฐ, ัะพััะพัะฝะธะต ะฒ ะฟะฐะผััะธ ะผะพะถะตั ะฝะต ัะพะฒะฟะฐะดะฐัั ั ัะฐะนะปะพะผ.

### ะัะพะฑะปะตะผะฐ 2: ะะฝะพะถะตััะฒะตะฝะฝัะต ะฒัะทะพะฒั `update_state()` 

ะะฐะถะดัะน ะฒัะทะพะฒ `update_state()` ะฒัะทัะฒะฐะตั `save_states()`, ะบะพัะพััะน:
- ะัะบััะฒะฐะตั ัะฐะนะป
- ะะตัะตะทะฐะฟะธััะฒะฐะตั ะะกะ ัะพััะพัะฝะธะต ะฒัะตั ะฟะฐั
- ะะฐะบััะฒะฐะตั ัะฐะนะป

ะัะปะธ ะฒ ัะธะบะปะต ะพะฑัะฐะฑะฐััะฒะฐะตััั 232 ะฟะฐัั, ัะพ `save_states()` ะฒัะทัะฒะฐะตััั ะผะฝะพะณะพ ัะฐะท, ััะพ ะผะพะถะตั ะฟัะธะฒะตััะธ ะบ:
- Race condition ะฟัะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพะน ะทะฐะฟะธัะธ
- ะะพัะตัะต ะดะฐะฝะฝัั ะตัะปะธ ะฟัะพัะตัั ะทะฐะฒะตััะธััั ะฒะพ ะฒัะตะผั ะทะฐะฟะธัะธ
- ะะฐะดะตัะถะบะฐะผ ะฟัะธ ัะพััะฐะฝะตะฝะธะธ

### ะัะพะฑะปะตะผะฐ 3: ะะตั ะฐัะพะผะฐัะฝะพััะธ ะฟัะธ ัะพััะฐะฝะตะฝะธะธ

ะกะพััะฐะฝะตะฝะธะต ัะพััะพัะฝะธั ะฟัะพะธััะพะดะธั **ะะะกะะ** ะพัะฟัะฐะฒะบะธ ัะธะณะฝะฐะปะฐ, ะฝะพ ะฟัะพะฒะตัะบะฐ ะฟัะพะธััะพะดะธั **ะะ**:
```
1. check_levels() โ ะฟัะพะฒะตััะตั triggered_levels
2. ะกะพะทะดะฐัั ัะธะณะฝะฐะป
3. ะัะฟัะฐะฒะปัะตั ะฒ Telegram
4. add_triggered_level() โ ะดะพะฑะฐะฒะปัะตั ะฒ triggered_levels
5. save_states() โ ัะพััะฐะฝัะตั ะฒ ัะฐะนะป
```

ะะตะถะดั ัะฐะณะฐะผะธ 1 ะธ 4 ะผะพะถะตั ะฟัะพะนัะธ ะฒัะตะผั, ะธ ะตัะปะธ ะฒ ััะพ ะฒัะตะผั ะฟัะพะธะทะพะนะดัั ัะปะตะดัััะธะน ัะธะบะป, ะพะฝ ะผะพะถะตั ัะฒะธะดะตัั ััะฐัะพะต ัะพััะพัะฝะธะต.

---

## โ ะะตัะตะฝะธะต: ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ะทะฐัะธัะฐ

### ะะฐัะธัะฐ 1: ะัั ะฒ `telegram_sender` (ะฟะพัะปะตะดะฝะธะน ะฑะฐััะตั)
```python
self.sent_signals_cache = {}  # {(pair, level): timestamp}
```
- ะฅัะฐะฝะธั ะฒ ะฟะฐะผััะธ ัะฟะธัะพะบ ะพัะฟัะฐะฒะปะตะฝะฝัั ัะธะณะฝะฐะปะพะฒ
- ะะปะพะบะธััะตั ะดัะฑะปะธ ะฒ ัะตัะตะฝะธะต 10 ะผะธะฝัั
- ะะต ะทะฐะฒะธัะธั ะพั ัะฐะนะปะพะฒะพะณะพ ัะพััะพัะฝะธั

### ะะฐัะธัะฐ 2: `is_duplicate_signal()` ะฒ `state_manager`
```python
def is_duplicate_signal(self, pair, level, current_time):
    # ะัะพะฒะตััะตั triggered_levels + last_signal_level + ะฒัะตะผั
```
- ะัะพะฒะตััะตั ะฝะตัะบะพะปัะบะพ ััะปะพะฒะธะน ะพะดะฝะพะฒัะตะผะตะฝะฝะพ
- ะะปะพะบะธััะตั ะตัะปะธ ัะพั ะถะต ััะพะฒะตะฝั ะฑัะป ะพัะฟัะฐะฒะปะตะฝ ะฝะตะดะฐะฒะฝะพ

### ะะฐัะธัะฐ 3: ะัะพะฒะตัะบะฐ ะฒ `main_loop` ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน
```python
final_signals = []
for signal in cycle_signals:
    if self.state_manager.is_duplicate_signal(...):
        continue
    final_signals.append(signal)
```
- ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน
- ะัะฟะพะปัะทัะตั ะฐะบััะฐะปัะฝะพะต ัะพััะพัะฝะธะต

---

## ๐ฏ ะัะพะณ:

**ะัะฑะปะธ ะฟัะพะธััะพะดัั ะฟะพัะพะผั ััะพ:**
1. ะกะพััะพัะฝะธะต (`triggered_levels`) ัะพััะฐะฝัะตััั **ะะะกะะ** ะพัะฟัะฐะฒะบะธ ัะธะณะฝะฐะปะฐ
2. ะะตะถะดั ะฟัะพะฒะตัะบะพะน ะธ ัะพััะฐะฝะตะฝะธะตะผ ะผะพะถะตั ะฟัะพะนัะธ ัะปะตะดัััะธะน ัะธะบะป
3. `check_levels()` ะฟัะพะฒะตััะตั **ะฟัะพัะตะฝั ะฟะฐะดะตะฝะธั**, ะฐ ะฝะต ัะฐะบั ะพัะฟัะฐะฒะบะธ
4. ะฆะตะฝะฐ ะผะพะถะตั ะพััะฐะฒะฐัััั ะฝะฐ ัะพะผ ะถะต ััะพะฒะฝะต ะผะตะถะดั ัะธะบะปะฐะผะธ (-12.9%)
5. ะกะพััะพัะฝะธะต ะฒ ะฟะฐะผััะธ ะผะพะถะตั ัะฐััะธะฝััะพะฝะธะทะธัะพะฒะฐัััั ั ัะฐะนะปะพะผ

**ะะตัะตะฝะธะต:**
- ะัั ะฒ `telegram_sender` - ะฟะพัะปะตะดะฝะธะน ะฑะฐััะตั, ะบะพัะพััะน ัะพัะฝะพ ะทะฝะฐะตั ััะพ ะฑัะปะพ ะพัะฟัะฐะฒะปะตะฝะพ
- ะะฝะพะถะตััะฒะตะฝะฝัะต ะฟัะพะฒะตัะบะธ ะฝะฐ ัะฐะทะฝัั ััะพะฒะฝัั
- ะะปะพะบะธัะพะฒะบะฐ ะฝะฐ 10 ะผะธะฝัั ะดะฐะถะต ะตัะปะธ ัะพััะพัะฝะธะต ะฝะต ัะพััะฐะฝะธะปะพัั
